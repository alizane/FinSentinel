<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Scenarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .mobile-frame {
            max-width: 400px; margin: 20px auto; background: #ffffff; min-height: 850px;
            border: 14px solid #1f2937; border-radius: 45px; overflow: hidden; position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4); display: flex; flex-direction: column;
        }
        .notch {
            width: 140px; height: 30px; background: #1f2937; margin: 0 auto;
            border-bottom-left-radius: 18px; border-bottom-right-radius: 18px; 
            position: absolute; left: 50%; transform: translateX(-50%); top: 0; z-index: 50;
        }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { color: #6b7280; font-weight: 500; }
        
        /* Table Styles */
        .data-table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 10px; }
        .data-table { width: 100%; min-width: 600px; border-collapse: collapse; font-size: 10px; }
        .data-table th { background: #f3f4f6; color: #6b7280; font-weight: 700; text-align: left; padding: 8px; border-bottom: 1px solid #e5e7eb; text-transform: uppercase; white-space: nowrap;}
        .data-table td { padding: 8px; border-bottom: 1px solid #f3f4f6; color: #374151; white-space: nowrap; }
        .data-table tr:last-child td { border-bottom: none; }
    </style>
</head>
<body>

    <div class="mobile-frame">
        <div class="notch"></div>

        <div class="bg-white pt-12 pb-4 px-6 border-b border-gray-100 sticky top-0 z-40">
            <div class="flex items-center gap-3 mb-4">
                <a href="index.html" class="text-xl text-gray-600 hover:text-gray-900">‚Üê</a>
                <h1 class="font-extrabold text-gray-800 text-lg">Scenario <span class="text-blue-500">Profiling</span></h1>
            </div>

            <div class="flex justify-around text-sm">
                <button onclick="switchTab('timeline')" id="btn-timeline" class="pb-2 w-1/2 text-center tab-active transition">
                    Velocity Profile
                </button>
                <button onclick="switchTab('beneficiary')" id="btn-beneficiary" class="pb-2 w-1/2 text-center tab-inactive transition">
                    Relational Profile
                </button>
            </div>
        </div>

        <div class="p-5 flex-grow overflow-y-auto bg-gray-50">
            
            <div class="mb-6">
                <label class="text-[10px] font-bold text-gray-400 uppercase">Select Customer</label>
                <select id="cust-select" onchange="loadData()" class="w-full p-3 mt-1 bg-white border border-gray-200 rounded-xl text-sm font-semibold text-gray-700 outline-none shadow-sm focus:border-blue-500 transition">
                    <option value="">Loading Customers...</option>
                </select>
            </div>

            <div id="view-timeline" class="space-y-3">
                <div class="flex justify-between items-center">
                    <h3 class="text-xs font-bold text-gray-500 uppercase">Global Spending Velocity</h3>
                    <span class="text-[9px] bg-blue-100 text-blue-600 px-2 py-1 rounded">Feature Store</span>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-2">
                    <div id="timeline-container" class="data-table-container">
                        <div class="text-center text-gray-400 text-xs py-10">Select a customer</div>
                    </div>
                </div>
            </div>

            <div id="view-beneficiary" class="hidden space-y-3">
                <div class="flex justify-between items-center">
                    <h3 class="text-xs font-bold text-gray-500 uppercase">A -> B Relationship Strength</h3>
                    <span class="text-[9px] bg-purple-100 text-purple-600 px-2 py-1 rounded">Graph Features</span>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-2">
                    <div id="ben-container" class="data-table-container">
                        <div class="text-center text-gray-400 text-xs py-10">Select a customer</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = "http://127.0.0.1:8000"; 
        let currentTab = 'timeline';

        // 1. Init: Load Customers
        window.onload = async () => {
            try {
                const res = await fetch(`${API_BASE}/get_customers`);
                const data = await res.json();
                const sSelect = document.getElementById('cust-select');
                sSelect.innerHTML = "<option value=''>-- Select to Analyze --</option>";
                if (data.customers) {
                    data.customers.forEach(cust => {
                        let opt = document.createElement("option");
                        opt.value = cust.id;
                        opt.text = `${cust.name} (ID: ${cust.id})`;
                        sSelect.add(opt);
                    });
                }
            } catch (e) { alert("API Error. Is backend running?"); }
        };

        // 2. Switch Tabs
        function switchTab(tab) {
            currentTab = tab;
            const btnT = document.getElementById('btn-timeline');
            const btnB = document.getElementById('btn-beneficiary');
            const viewT = document.getElementById('view-timeline');
            const viewB = document.getElementById('view-beneficiary');

            if (tab === 'timeline') {
                btnT.className = "pb-2 w-1/2 text-center tab-active transition";
                btnB.className = "pb-2 w-1/2 text-center tab-inactive transition";
                viewT.classList.remove('hidden');
                viewB.classList.add('hidden');
            } else {
                btnT.className = "pb-2 w-1/2 text-center tab-inactive transition";
                btnB.className = "pb-2 w-1/2 text-center tab-active transition";
                viewT.classList.add('hidden');
                viewB.classList.remove('hidden');
            }
            if (document.getElementById('cust-select').value) loadData();
        }

        // 3. Load Data
        async function loadData() {
            const custId = document.getElementById('cust-select').value;
            if (!custId) return;

            if (currentTab === 'timeline') fetchTimeline(custId);
            else fetchBeneficiaries(custId);
        }

        // 4. Render Timeline (Single Row usually)
        async function fetchTimeline(custId) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '<div class="text-center text-xs text-gray-400">Loading profile...</div>';

            try {
                const res = await fetch(`${API_BASE}/get_profile_timeline`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({customer_id: parseInt(custId)})
                });
                const data = await res.json();

                if (data.timeline && data.timeline.length > 0) {
                    let html = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Total Spend</th>
                                    <th>Active Days</th>
                                    <th>Daily Avg</th>
                                    <th>Weekly Avg</th>
                                    <th>Monthly Avg</th>
                                    <th>Yearly Avg</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    data.timeline.forEach(row => {
                        html += `
                            <tr>
                                <td class="font-bold text-blue-600">${row.grand_total}</td>
                                <td>${row.active_days}</td>
                                <td>${row.daily_avg}</td>
                                <td>${row.weekly_avg}</td>
                                <td>${row.monthly_avg}</td>
                                <td>${row.yearly_avg}</td>
                            </tr>
                        `;
                    });
                    html += `</tbody></table>`;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="text-center text-xs text-gray-400">No velocity profile found.</div>';
                }
            } catch (e) { container.innerHTML = "Error loading data."; }
        }

        // 5. Render Beneficiaries
        async function fetchBeneficiaries(custId) {
            const container = document.getElementById('ben-container');
            container.innerHTML = '<div class="text-center text-xs text-gray-400">Loading graph...</div>';

            try {
                const res = await fetch(`${API_BASE}/get_profile_beneficiary`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({customer_id: parseInt(custId)})
                });
                const data = await res.json();

                if (data.beneficiaries && data.beneficiaries.length > 0) {
                    let html = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Beneficiary</th>
                                    <th>Total Sent</th>
                                    <th>Count</th>
                                    <th>Active Days</th>
                                    <th>Daily Avg</th>
                                    <th>Monthly Avg</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    data.beneficiaries.forEach(row => {
                        html += `
                            <tr>
                                <td class="font-bold text-gray-700">${row.beneficiary}</td>
                                <td class="text-blue-600 font-bold">${row.total}</td>
                                <td>${row.count}</td>
                                <td>${row.days}</td>
                                <td>${row.daily}</td>
                                <td>${row.monthly}</td>
                            </tr>
                        `;
                    });
                    html += `</tbody></table>`;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="text-center text-xs text-gray-400">No relationship profile found.</div>';
                }
            } catch (e) { container.innerHTML = "Error loading data."; }
        }
    </script>

</body>
</html>