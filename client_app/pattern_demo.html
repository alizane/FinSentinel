<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anomaly Defense Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .mobile-frame {
            max-width: 400px; margin: 20px auto; background: #fff; min-height: 800px;
            border: 14px solid #1f2937; border-radius: 45px; overflow: hidden; position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
        }
        .notch {
            width: 140px; height: 30px; background: #1f2937; margin: 0 auto;
            border-bottom-left-radius: 18px; border-bottom-right-radius: 18px; 
            position: absolute; left: 50%; transform: translateX(-50%); top: 0; z-index: 50;
        }
    </style>
</head>
<body>

<div class="mobile-frame">
    <div class="notch"></div>

    <div class="bg-indigo-600 pt-12 pb-6 px-6 text-white shadow-md relative z-10">
        <div class="flex items-center gap-3">
            <a href="index.html" class="text-xl hover:opacity-80">‚Üê</a>
            <h1 class="font-bold text-lg">Pay Vendor</h1>
        </div>
        <p class="text-xs opacity-80 mt-1 pl-6">Protected by Isolation Forest</p>
    </div>

    <div id="input-screen" class="p-6 relative z-0">
        <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg mb-6">
            <p class="text-[10px] font-bold text-yellow-700 uppercase mb-2">üéì Demo Mode</p>
            <select id="scenario-selector" onchange="autoFill()" class="w-full text-sm p-2 border rounded bg-white cursor-pointer">
                <option value="clean">üü¢ Scenario 1: Legit Vendor (Rent)</option>
                <option value="shell">üî¥ Scenario 2: Shell Company (Zero OpEx)</option>
            </select>
        </div>

        <div class="space-y-4">
            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Vendor Name</label>
                <input type="text" id="vendor" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-lg outline-none border focus:border-indigo-500 transition" value="WeWork India">
                <p class="text-[10px] text-gray-400 mt-1" id="vendor-status">Business Health: Verified</p>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500 uppercase">Invoice Amount (‚Çπ)</label>
                <input type="number" id="amount" class="w-full p-4 bg-gray-50 rounded-xl font-bold text-lg outline-none border focus:border-indigo-500 transition" value="25000">
            </div>

            <button onclick="processPayment()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-200 transition mt-4 transform active:scale-95">
                Process Invoice
            </button>
        </div>
    </div>

    <div id="loading-screen" class="hidden h-full flex flex-col items-center justify-center bg-white absolute top-0 w-full z-20">
        <div class="animate-spin w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full mb-4"></div>
        <h2 class="font-bold text-gray-800">Auditing Vendor...</h2>
        <p class="text-xs text-gray-500 mt-2">Calculating Outlier Score</p>
    </div>

    <div id="result-screen" class="hidden h-full flex flex-col items-center justify-center bg-white absolute top-0 w-full z-30 p-6 text-center">
        <div id="res-icon" class="text-6xl mb-4"></div>
        <h2 id="res-title" class="text-2xl font-bold mb-2"></h2>
        <p id="res-msg" class="text-gray-500 mb-6"></p>

        <div id="evidence-box" class="bg-red-50 p-4 rounded-xl border border-red-100 w-full text-left hidden">
            <p class="text-[10px] font-bold text-red-500 uppercase">Isolation Forest Verdict</p>
            <p class="text-sm font-bold text-gray-800 mt-1" id="iso-verdict"></p>
            <p class="text-xs text-gray-600 mt-1 bg-white p-2 rounded border border-red-100" id="iso-reason"></p>
        </div>

        <button onclick="location.reload()" class="mt-8 w-full bg-gray-900 text-white py-3 rounded-xl font-bold">Try Again</button>
    </div>
</div>

<script>
    const API_URL = "http://127.0.0.1:8000/analyze_transaction/";

    function autoFill() {
        const type = document.getElementById('scenario-selector').value;
        if (type === 'clean') {
            document.getElementById('vendor').value = "WeWork India";
            document.getElementById('amount').value = "25000";
            document.getElementById('vendor-status').innerText = "Business Health: Active OpEx";
        } else {
            document.getElementById('vendor').value = "SHELL_CORP_LTD";
            document.getElementById('amount').value = "500000";
            document.getElementById('vendor-status').innerText = "Business Health: No OpEx Detected";
        }
    }

    function processPayment() {
        const type = document.getElementById('scenario-selector').value;
        document.getElementById('loading-screen').classList.remove('hidden');

        let payload = {};
        if (type === 'clean') {
            payload = { customer_id: 101, amount: 25000, device_id: "Office_PC", beneficiary_account: "WeWork_ACC", account_age_days: 900 };
        } else {
            payload = { customer_id: 666, amount: 500000, device_id: "HQ_PC", beneficiary_account: "SHELL_CORP", account_age_days: 10 };
        }

        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => showResult(data))
        .catch(err => {
            alert("API Error");
            location.reload();
        });
    }

    function showResult(data) {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        const evBox = document.getElementById('evidence-box');

        if (data.status === "APPROVED") {
            document.getElementById('res-icon').innerHTML = "‚úÖ";
            document.getElementById('res-title').innerText = "Invoice Paid";
            document.getElementById('res-msg').innerText = "Vendor Verified";
            evBox.classList.add('hidden');
        } else {
            document.getElementById('res-icon').innerHTML = "üõë";
            document.getElementById('res-title').innerText = "Payment Blocked";
            document.getElementById('res-msg').innerText = "Shell Company Detected";
            evBox.classList.remove('hidden');

            const isoData = data.model_breakdown.Anomaly_Model;
            document.getElementById('iso-verdict').innerText = isoData.verdict;
            document.getElementById('iso-reason').innerText = "Anomaly Score: " + isoData.score.toFixed(4);
        }
    }
</script>
</body>
</html>